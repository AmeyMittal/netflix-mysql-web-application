<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netflix - Home</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #141414;
            color: white;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        .netflix-red {
            color: #e50914;
        }

        .btn-play {
            background-color: white;
            color: black;
        }

        .btn-play:hover {
            background-color: rgba(255, 255, 255, 0.75);
        }

        .btn-info {
            background-color: rgba(109, 109, 110, 0.7);
            color: white;
        }

        .btn-info:hover {
            background-color: rgba(109, 109, 110, 0.4);
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="fixed w-full z-10 bg-gradient-to-b from-black to-transparent px-10 py-4 flex justify-between items-center transition duration-500"
        id="navbar">
        <h1 class="netflix-red text-3xl font-bold uppercase tracking-tighter">NEWS</h1>
        <div class="flex items-center space-x-4">
            <span id="welcomeUser" class="text-sm font-medium">Hello, Viewer</span>
            <button id="logoutBtn" class="bg-red-600 px-4 py-1 rounded text-sm hover:bg-red-700">Sign Out</button>
        </div>
    </nav>

    <!-- Hero -->
    <div class="relative h-[80vh] w-full bg-cover bg-center flex items-center px-10"
        style="background-image: linear-gradient(to top, #141414, transparent), url('https://image.tmdb.org/t/p/original/56v2KjBlU4XaOv9rVYkJu64HIIV.jpg');">
        <div class="max-w-xl space-y-4">
            <h1 class="text-6xl font-black drop-shadow-lg">Stranger Things</h1>
            <p class="text-lg drop-shadow-md">
                When a young boy vanishes, a small town uncovers a mystery involving secret experiments, terrifying
                supernatural forces, and one strange little girl.
            </p>
            <div class="flex space-x-3">
                <button class="btn-play px-6 py-2 rounded font-bold flex items-center">
                    ▶ Play
                </button>
                <button class="btn-info px-6 py-2 rounded font-bold flex items-center">
                    ⓘ More Info
                </button>
            </div>
        </div>
    </div>

    <!-- Content Grid -->
    <div class="px-10 py-8 -mt-20 relative z-10">
        <h2 class="text-xl font-bold mb-4">Popular on NEWS</h2>
        <div id="seriesGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
            <!-- Cards injected via JS -->
        </div>
    </div>

    <!-- Watch/Feedback Modal (Hidden) -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-lg max-w-2xl w-full p-6 relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-2xl">×</button>

            <h2 id="modalTitle" class="text-3xl font-bold mb-2">Series Title</h2>
            <div class="flex space-x-4 border-b border-gray-700 pb-4 mb-4">
                <button onclick="showTab('episodes')" class="text-lg font-bold hover:text-red-500">Episodes</button>
                <button onclick="showTab('feedback')" class="text-lg font-bold hover:text-red-500">Rate &
                    Review</button>
            </div>

            <!-- Tab: Episodes -->
            <div id="tabEpisodes" class="h-64 overflow-y-auto space-y-2">
                <!-- List -->
            </div>

            <!-- Tab: Feedback -->
            <div id="tabFeedback" class="hidden h-64">
                <textarea id="feedbackText" class="w-full h-32 bg-gray-800 p-2 rounded text-white"
                    placeholder="Write a review..."></textarea>
                <div class="mt-4 flex items-center space-x-4">
                    <select id="ratingScore" class="bg-gray-800 p-2 rounded">
                        <option value="5">⭐⭐⭐⭐⭐ 5 - Amazing</option>
                        <option value="4">⭐⭐⭐⭐ 4 - Good</option>
                        <option value="3">⭐⭐⭐ 3 - Okay</option>
                        <option value="2">⭐⭐ 2 - Bad</option>
                        <option value="1">⭐ 1 - Terrible</option>
                    </select>
                    <button onclick="submitFeedback()"
                        class="bg-red-600 px-6 py-2 rounded font-bold hover:bg-red-700">Submit</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let currentSeriesId = null;

        // 1. Check Auth
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user) window.location.href = 'index.html';
        document.getElementById('welcomeUser').innerText = `Hello, ${user.email}`;

        // 2. Load Content
        async function loadContent() {
            const res = await fetch(`${API_BASE}/browse`);
            const series = await res.json();
            const grid = document.getElementById('seriesGrid');

            series.forEach(s => {
                const card = document.createElement('div');
                card.className = 'bg-gray-800 rounded hover:scale-105 transition duration-300 cursor-pointer p-4 h-48 flex flex-col justify-end relative group';
                // Placeholder gradient instead of real images for now
                card.style.backgroundImage = `linear-gradient(to top, black, transparent), url('https://picsum.photos/seed/${s.webseries_id}/300/400')`;
                card.style.backgroundSize = 'cover';

                card.innerHTML = `
                    <div>
                        <h3 class="font-bold text-lg leading-tight">${s.series_name}</h3>
                        <p class="text-xs text-gray-300 line-clamp-1">${s.genres || 'Drama'}</p>
                    </div>
                `;
                card.onclick = () => openModal(s);
                grid.appendChild(card);
            });
        }

        // 3. Modal Logic
        async function openModal(series) {
            currentSeriesId = series.webseries_id;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modalTitle').innerText = series.series_name;
            showTab('episodes'); // Reset tab

            // Load Episodes
            const res = await fetch(`${API_BASE}/series/${series.webseries_id}/episodes`);
            const episodes = await res.json();
            const list = document.getElementById('tabEpisodes');
            list.innerHTML = '';

            episodes.forEach(ep => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-3 hover:bg-gray-800 rounded cursor-pointer group';
                item.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-400 font-bold">${ep.episode_number}</span>
                        <span>${ep.episode_title}</span>
                    </div>
                    <span class="text-xs text-gray-500 group-hover:hidden">${ep.duration_min}m</span>
                    <button class="hidden group-hover:block text-xs bg-white text-black px-2 py-1 rounded font-bold">▶ View</button>
                `;
                item.onclick = () => recordView(ep.episode_id);
                list.appendChild(item);
            });
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function showTab(tabName) {
            if (tabName === 'episodes') {
                document.getElementById('tabEpisodes').classList.remove('hidden');
                document.getElementById('tabFeedback').classList.add('hidden');
            } else {
                document.getElementById('tabEpisodes').classList.add('hidden');
                document.getElementById('tabFeedback').classList.remove('hidden');
            }
        }

        // 4. Record View
        async function recordView(epId) {
            try {
                await fetch(`${API_BASE}/view`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ account_id: user.accountId, episode_id: epId })
                });
                alert('Viewing Recorded! (Check Analytics)');
            } catch (err) {
                console.error(err);
            }
        }

        // 5. Submit Feedback
        async function submitFeedback() {
            const feedback = document.getElementById('feedbackText').value;
            const rating = document.getElementById('ratingScore').value;

            try {
                await fetch(`${API_BASE}/feedback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        account_id: user.accountId,
                        webseries_id: currentSeriesId,
                        feedback_text: feedback,
                        rating: rating
                    })
                });
                alert('Thanks for your review!');
                closeModal();
            } catch (err) {
                console.error(err);
            }
        }

        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        });

        // Navbar Scroll Effect
        window.addEventListener('scroll', () => {
            const nav = document.getElementById('navbar');
            if (window.scrollY > 50) nav.classList.add('bg-black');
            else nav.classList.remove('bg-black');
        });

        loadContent();
    </script>
</body>

</html>